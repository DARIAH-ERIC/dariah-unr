generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

// -------------------------------------------------------------------------------------------------

enum BodyType {
  bod
  dco
  ga
  jrc
  ncc
  sb
  smt

  @@map(name: "body_type")
}

model Body {
  id String @id @default(uuid()) @db.Uuid

  acronym String?
  name    String
  type    BodyType

  roles Role[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "bodies")
}

model Contribution {
  id String @id @default(uuid()) @db.Uuid

  endDate   DateTime? @map(name: "end_date")
  startDate DateTime? @map(name: "start_date")

  countryId      String? @map(name: "country_id") @db.Uuid
  personId       String  @map(name: "person_id") @db.Uuid
  roleId         String  @map(name: "role_id") @db.Uuid
  workingGroupId String? @map(name: "working_group_id") @db.Uuid

  country      Country?      @relation(fields: [countryId], references: [id])
  person       Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  role         Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  workingGroup WorkingGroup? @relation(fields: [workingGroupId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "contributions")
}

enum CountryType {
  cooperating_partnership
  member_country
  other

  @@map(name: "country_type")
}

model Country {
  id String @id @default(uuid()) @db.Uuid

  code           String
  consortiumName String?   @map(name: "consortium_name")
  description    String?
  endDate        DateTime? @map(name: "end_date")
  logo           String?
  marketplaceId  Int?      @map(name: "marketplace_id")

  name      String
  startDate DateTime?   @map(name: "start_date")
  type      CountryType

  contributions Contribution[]
  institutions  Institution[]
  outreach      Outreach[]
  reports       Report[]
  services      Service[]
  software      Software[]
  users         User[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@index(fields: [code])
  @@map(name: "countries")
}

model EventReport {
  id String @id @default(uuid()) @db.Uuid

  dariahCommissionedEvent String? @map(name: "dariah_commissioned_event")
  largeMeetings           Int?    @map(name: "very_large_meetings")
  mediumMeetings          Int?    @map(name: "medium_meetings")
  reusableOutcomes        String? @map(name: "reusable_outcomes")
  smallMeetings           Int?    @map(name: "small_meetings")
  veryLargeMeetings       Int?    @map(name: "large_meetings")

  reportId String @unique @map(name: "report_id") @db.Uuid

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "event_reports")
}

enum InstitutionType {
  cooperating_partner
  national_coordinating_institution
  national_representative_institution
  other
  partner_institution

  @@map(name: "institution_type")
}

model Institution {
  id String @id @default(uuid()) @db.Uuid

  endDate   DateTime?         @map(name: "end_date")
  name      String
  ror       String?
  startDate DateTime?         @map(name: "start_date")
  types     InstitutionType[]
  url       String[]

  countries Country[]
  persons   Person[]
  services  InstitutionToService[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "institutions")
}

enum InstitutionServiceRole {
  content_provider
  service_owner
  service_provider
  technical_contact

  @@map(name: "institution_service_role")
}

model InstitutionToService {
  role InstitutionServiceRole

  institutionId String @map(name: "institution_id") @db.Uuid
  serviceId     String @map(name: "service_id") @db.Uuid

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([institutionId, role, serviceId])
  @@map(name: "institution_service")
}

enum OutreachType {
  national_social_media
  national_website
  social_media

  @@map(name: "outreach_type")
}

model Outreach {
  id String @id @default(uuid()) @db.Uuid

  endDate   DateTime?    @map(name: "end_date")
  name      String
  startDate DateTime?    @map(name: "start_date")
  type      OutreachType
  url       String

  countryId String? @map(name: "country_id") @db.Uuid

  country Country?         @relation(fields: [countryId], references: [id], onDelete: Cascade)
  reports OutreachReport[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "outreach")
}

model OutreachReport {
  id String @id @default(uuid()) @db.Uuid

  outreachId String @map(name: "outreach_id") @db.Uuid
  reportId   String @map(name: "report_id") @db.Uuid

  kpis     OutreachKpi[]
  outreach Outreach      @relation(fields: [outreachId], references: [id], onDelete: Cascade)
  report   Report        @relation(fields: [reportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "outreach_reports")
}

enum OutreachKpiType {
  engagement
  followers
  impressions
  mention
  new_content
  page_views
  posts
  reach
  subscribers
  unique_visitors
  views
  watch_time

  @@map(name: "outreach_kpi_type")
}

model OutreachKpi {
  id String @id @default(uuid()) @db.Uuid

  unit  OutreachKpiType
  value Int

  outreachReportId String @map(name: "outreach_report_id") @db.Uuid

  outreachReport OutreachReport @relation(fields: [outreachReportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "outreach_kpis")
}

model Person {
  id String @id @default(uuid()) @db.Uuid

  // `prisma` currently does not support unique constraints on nullable fields, even though postgres does
  // @see https://github.com/prisma/prisma/issues/3387
  email String? // @unique
  name  String
  orcid String?

  contributions Contribution[]
  institutions  Institution[]
  users         User[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "persons")
}

enum ProjectScope {
  eu
  national
  regional

  @@map(name: "project_scope")
}

model ProjectsFundingLeverage {
  id String @id @default(uuid()) @db.Uuid

  amount        Decimal?      @db.Decimal(12, 2)
  funders       String?
  name          String
  projectMonths Int?          @map(name: "project_months")
  scope         ProjectScope?
  startDate     DateTime?     @map(name: "start_date")
  totalAmount   Decimal?      @map(name: "total_amount") @db.Decimal(12, 2)

  reportId String @map(name: "report_id") @db.Uuid

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "projects")
}

enum ReportStatus {
  draft
  final

  @@map(name: "report_status")
}

model Report {
  id String @id @default(uuid()) @db.Uuid

  comments                 Json?
  contributionsCount       Int?         @map(name: "contributions_count")
  operationalCost          Decimal?     @map(name: "operational_cost") @db.Decimal(12, 2)
  operationalCostDetail    Json?        @map(name: "operational_cost_detail")
  operationalCostThreshold Decimal?     @map(name: "operational_cost_threshold") @db.Decimal(12, 2)
  status                   ReportStatus @default(draft)
  // FIXME: remove
  year                     Int

  countryId        String  @map(name: "country_id") @db.Uuid
  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid

  country                    Country                     @relation(fields: [countryId], references: [id], onDelete: Cascade)
  eventReport                EventReport?
  outreachReports            OutreachReport[]
  projectsFundingLeverages   ProjectsFundingLeverage[]
  reportCampaign             ReportCampaign?             @relation(fields: [reportCampaignId], references: [id])
  researchPolicyDevelopments ResearchPolicyDevelopment[]
  serviceReports             ServiceReport[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, countryId])
  @@index(fields: [reportCampaignId])
  @@map(name: "reports")
}

enum ResearchPolicyLevel {
  eu
  international
  institutional
  national
  regional

  @@map(name: "research_policy_level")
}

model ResearchPolicyDevelopment {
  id String @id @default(uuid()) @db.Uuid

  level   ResearchPolicyLevel
  name    String
  outcome String?

  reportId String @map(name: "report_id") @db.Uuid

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "research_policy_developments")
}

enum RoleType {
  dco_member
  director
  national_coordinator
  national_coordinator_deputy
  national_representative
  national_representative_deputy
  jrc_chair
  jrc_member
  scientific_board_member
  smt_member
  wg_chair
  wg_member
  national_consortium_contact
  cooperating_partner_contact
  ncc_chair

  @@map(name: "role_type")
}

model Role {
  id String @id @default(uuid()) @db.Uuid

  // FIXME: remove
  annualValue Int      @map(name: "annual_value")
  name        String
  type        RoleType

  bodies        Body[]
  contributions Contribution[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "roles")
}

enum ServiceAudience {
  dariah_team
  global
  national_local

  @@map(name: "service_audience")
}

enum ServiceMarketplaceStatus {
  no
  not_applicable
  yes

  @@map(name: "service_marketplace_status")
}

enum ServiceStatus {
  discontinued
  in_preparation
  live
  needs_review
  to_be_discontinued

  @@map(name: "service_status")
}

enum ServiceType {
  community
  core
  internal

  @@map(name: "service_type")
}

model Service {
  id String @id @default(uuid()) @db.Uuid

  agreements              String?
  audience                ServiceAudience?
  comment                 String?
  dariahBranding          Boolean?                  @map(name: "dariah_branding")
  eoscOnboarding          Boolean?                  @map(name: "eosc_onboarding")
  marketplaceStatus       ServiceMarketplaceStatus? @map(name: "marketplace_status")
  marketplaceId           String?                   @map(name: "marketplace_id")
  monitoring              Boolean?
  name                    String
  privateSupplier         Boolean?                  @map(name: "private_supplier")
  status                  ServiceStatus?
  technicalContact        String?                   @map(name: "technical_contact")
  technicalReadinessLevel Int?                      @map(name: "technical_readiness_level")
  type                    ServiceType?
  url                     String[]
  valueProposition        String?                   @map(name: "value_proposition")

  countries    Country[]
  institutions InstitutionToService[]
  reports      ServiceReport[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "services")
}

model ServiceReport {
  id String @id @default(uuid()) @db.Uuid

  reportId  String @map(name: "report_id") @db.Uuid
  serviceId String @map(name: "service_id") @db.Uuid

  kpis    ServiceKpi[]
  report  Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  service Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "service_reports")
}

enum ServiceKpiType {
  downloads
  hits
  items
  jobs_processed
  page_views
  registered_users
  searches
  sessions
  unique_users
  visits
  websites_hosted

  @@map(name: "service_kpi_type")
}

model ServiceKpi {
  id String @id @default(uuid()) @db.Uuid

  unit  ServiceKpiType
  value Int

  serviceReportId String @map(name: "service_report_id") @db.Uuid

  serviceReport ServiceReport @relation(fields: [serviceReportId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "service_kpis")
}

enum SoftwareMarketplaceStatus {
  added_as_external_id
  added_as_item
  no
  not_applicable

  @@map(name: "software_marketplace_status")
}

enum SoftwareStatus {
  maintained
  needs_review
  not_maintained

  @@map(name: "software_status")
}

model Software {
  id String @id @default(uuid()) @db.Uuid

  comment           String?
  name              String
  marketplaceStatus SoftwareMarketplaceStatus? @map(name: "marketplace_status")
  marketplaceId     String?                    @map(name: "marketplace_id")
  status            SoftwareStatus?
  url               String[]

  countries Country[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "software")
}

model WorkingGroup {
  id String @id @default(uuid()) @db.Uuid

  contactEmail   String?   @map(name: "contact_email")
  endDate        DateTime? @map(name: "end_date")
  mailingList    String?   @map(name: "mailing_list")
  memberTracking String?   @map(name: "member_tracking")
  name           String
  slug           String
  startDate      DateTime? @map(name: "start_date")

  chairs   Contribution[]
  outreach WorkingGroupOutreach[]
  reports  WorkingGroupReport[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@index(fields: [slug])
  @@map(name: "working_groups")
}

model WorkingGroupReport {
  id String @id @default(uuid()) @db.Uuid

  comments             Json?
  facultativeQuestions String       @map(name: "facultative_questions")
  members              Int?
  narrativeReport      String       @map(name: "narrative_report")
  status               ReportStatus @default(draft)
  // FIXME: remove
  year                 Int

  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid
  workingGroupId   String  @map(name: "working_group_id") @db.Uuid

  reportCampaign     ReportCampaign?     @relation(fields: [reportCampaignId], references: [id])
  workingGroup       WorkingGroup        @relation(fields: [workingGroupId], references: [id])
  workingGroupEvents WorkingGroupEvent[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, workingGroupId])
  @@index(fields: [reportCampaignId])
  @@map(name: "working_group_reports")
}

enum WorkingGroupEventRole {
  organiser
  presenter

  @@map(name: "working_group_event_role")
}

model WorkingGroupEvent {
  id String @id @default(uuid()) @db.Uuid

  date  DateTime?
  role  WorkingGroupEventRole
  title String
  url   String

  reportId String @map(name: "report_id") @db.Uuid

  report WorkingGroupReport @relation(fields: [reportId], references: [id])

  @@map(name: "working_group_events")
}

enum WorkingGroupOutreachType {
  website
  social_media

  @@map(name: "working_group_outreach_type")
}

model WorkingGroupOutreach {
  id String @id @default(uuid()) @db.Uuid

  endDate   DateTime?    @map(name: "end_date")
  name      String
  startDate DateTime?    @map(name: "start_date")
  type      OutreachType
  url       String

  workingGroupId String @map(name: "working_group_id") @db.Uuid

  workingGroup WorkingGroup @relation(fields: [workingGroupId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@map(name: "working_group_outreach")
}

// -------------------------------------------------------------------------------------------------

enum EventSize {
  dariah_commissioned
  large
  medium
  small
  very_large

  @@map(name: "event_size")
}

model EventSizeValue {
  id String @id @default(uuid()) @db.Uuid

  annualValue Int       @map(name: "annual_value")
  type        EventSize

  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid

  reportCampaign ReportCampaign? @relation(fields: [reportCampaignId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, type])
  @@map(name: "event_size_values")
}

model OutreachTypeValue {
  id String @id @default(uuid()) @db.Uuid

  annualValue Int          @map(name: "annual_value")
  type        OutreachType

  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid

  reportCampaign ReportCampaign? @relation(fields: [reportCampaignId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, type])
  @@map(name: "outreach_type_values")
}

model RoleTypeValue {
  id String @id @default(uuid()) @db.Uuid

  annualValue Int      @map(name: "annual_value")
  type        RoleType

  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid

  reportCampaign ReportCampaign? @relation(fields: [reportCampaignId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, type])
  @@map(name: "role_values")
}

enum ServiceSize {
  core
  large
  medium
  small

  @@map(name: "service_size")
}

model ServiceSizeValue {
  id String @id @default(uuid()) @db.Uuid

  annualValue Int         @map(name: "annual_value")
  type        ServiceSize

  // FIXME: required
  reportCampaignId String? @map(name: "report_campaign_id") @db.Uuid

  reportCampaign ReportCampaign? @relation(fields: [reportCampaignId], references: [id])

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  // @@unique([reportCampaignId, type])
  @@map(name: "service_size_values")
}

enum ReportCampaignStatus {
  in_progress
  done

  @@map(name: "report_campaign_status")
}

model ReportCampaign {
  id String @id @default(uuid()) @db.Uuid

  serviceSizeThresholds Json                 @map(name: "service_size_thresholds") // could become a separate thing
  status                ReportCampaignStatus @default(in_progress)
  year                  Int                  @unique

  reports             Report[]
  workingGroupReports WorkingGroupReport[]

  eventSizeValues    EventSizeValue[]
  outreachTypeValues OutreachTypeValue[]
  roleTypeValues     RoleTypeValue[]
  serviceSizeValues  ServiceSizeValue[]

  createdAt DateTime @default(now()) @map(name: "created_at")
  updatedAt DateTime @updatedAt @map(name: "updated_at")

  @@index(fields: [year])
  @@map(name: "report_campaigns")
}

// -------------------------------------------------------------------------------------------------

enum UserRole {
  admin
  contributor
  national_coordinator

  @@map(name: "user_role")
}

model User {
  id String @id @default(uuid()) @db.Uuid

  email    String   @unique
  name     String
  password String
  role     UserRole @default(contributor)

  countryId String? @map(name: "country_id") @db.Uuid
  personId  String? @map(name: "person_id") @db.Uuid

  country  Country?  @relation(fields: [countryId], references: [id])
  person   Person?   @relation(fields: [personId], references: [id])
  sessions Session[]

  @@map(name: "users")
}

model Session {
  id String @id

  secretHash     Bytes    @map(name: "secret_hash") @db.ByteA
  createdAt      DateTime @map(name: "created_at")
  lastVerifiedAt DateTime @map(name: "last_verified_at")

  userId String @map(name: "user_id") @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map(name: "sessions")
}
